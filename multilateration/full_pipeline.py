import serial
from scipy import signal
import numpy as np

import sympy as sp
import scipy
import matplotlib.pyplot as plt
import random
import math
import sys

from itertools import combinations

from sympy import Eq, solve_linear_system, Matrix
from sympy.interactive import printing

from scipy.optimize import least_squares

printing.init_printing(use_unicode=True)

# Random Seed
random.seed(69)


from pynmeagps import NMEAReader



def find_str(s, start, end):
    substart = s.find(start) + len(start)
    subend = s.find(end)

    substring = s[substart:subend]

    return substring

def twos_complement(hexstr, bits):

    value = int(hexstr,16)

    if value & (1 << (bits-1)):

        value -= 1 << bits

    return value

def get_uart(port, baud, timeout_val):
    
    ser = serial.Serial(port, baud, timeout=timeout_val)
    blank = ''

    sound_data = blank

    meta_start  = 'abababab'
    meta_end    = 'cdcdcdcd'

    sound_start = 'cdcdcdcd'
    sound_end   = 'efefefef'
    
    #print(meta_start)

    last_8 = None

    # read serial port until stop character is hit
    while True:
        input_data = ser.readline()
        data = input_data.hex()
        #data = bytes(input_data)
        if data != blank:
            print(data)
            sound_data = sound_data + data
        
        if sound_data.find(sound_end) != -1:
            break

    meta = find_str(sound_data, meta_start, meta_end)
    sound = find_str(sound_data, sound_start, sound_end)
    #print('meta_data: ', meta)
    #print('sound_data: ', sound)

    return meta, sound

# meta_data_formatting: 
#    timer = first 8 char
#    name = next 8 char
#    gps = the rest
def parse_uart(meta, sound):
    # convert raw time to usable time
    raw_time = meta[:8]
    reversed_time = ''
    
    # reverse the order of the bytes
    for code in (raw_time[i:i+2] for i in range(len(raw_time)-2, -1, -2)):
        reversed_time += code

    # convert to samples
    output_time = int(reversed_time, 16)
    output_time /= 90000000.0
    

    raw_name = meta[8:16]
    output_name = raw_name.replace('0', '')

    # convert Raw gps Data
    raw_gps = meta[16:]
    gps_processed = NMEAReader.parse(bytes.fromhex(raw_gps).decode('utf-8'))
    

    x = float(gps_processed.payload[2])/100
    frac_x, whole_x = math.modf(x)
    x = whole_x + (frac_x * 100) / 60

    y = float(gps_processed.payload[0])/100
    frac_y, whole_y = math.modf(y)
    y = whole_y + (frac_y * 100) / 60

    if gps_processed.payload[1] == 'S':
        y = -1*y

    if gps_processed.payload[3] == 'W':
        x = -1*x

    print(x)
    print(y)

    output_gps = [x, y]

    #convert raw sound to usable sound
    output_sound = [0]*(int(len(sound) / 4))

    # loop through grouping of two bytes and then reverse their order: abcd -> cdab
    j = 0
    for a, b, c, d in (sound[i:i+4] for i in range(0, len(sound), 4)):
        code = c+d+a+b
        output_sound[j] = twos_complement(code, 16)
        j += 1

    #print(output_sound)
    #print(len(output_sound))
    #print(raw_time)
    #print(output_time)
    return [output_name, output_time, output_gps, output_sound]

# add padding to make the timestamps line up
#NOTE: use sound in secs not samples
def pad_sound(time_a, sample_a, time_b, sample_b, sample_rate):
    offset = time_a - time_b
    offset *= sample_rate
    offset = int(offset)
    #print('offset: ', offset)

    if(offset > 0):
        padding = [0]*abs(offset)
        sample_a = padding + sample_a
        sample_b = sample_b + padding

    if(offset < 0):
        padding = [0]*abs(offset)
        sample_b = padding + sample_b
        sample_a = sample_a + padding

    #print(len(sample_a))
    #print(len(sample_b))

    return sample_a, sample_b

def TDOA(signal_a, signal_b, sample_rate):
    #print(signal_a)
    #print(signal_b)
    c = signal.correlate(signal_a, signal_b, mode="full", method="fft")
    max_ind = np.argmax(np.abs(c))
    shift = (len(signal_b)-1) - max_ind
    return shift / sample_rate

#returns the difference in ToA of a and b: Ta - Tb
def cross_correlation(time_a, sample_a, time_b, sample_b, sample_rate):
    #print(sample_a)
    #print(sample_b)
    sample_a, sample_b = pad_sound(time_a, sample_a, time_b, sample_b, sample_rate)

    difference = TDOA(sample_a, sample_b, sample_rate)

    return difference

def LST(nodes, times, v):

	print(nodes)
	#print(times)

	#print(np.array(nodes))
	#print(np.array([times]).T)

	nodes = np.concatenate((np.array(nodes), np.array([times]).T), axis=1).tolist()
	#nodes = zip(nodes,times)
	#print(nodes)
	def equations(guess):
			x, y, r = guess

			output = []
			
			#print(nodes)
			for combo in combinations(nodes, 2):
				#print('COMBO: ', combo)
				n1 = combo[0]
				n2 = combo[1]
				x1 = n1[0]
				y1 = n1[1]
				x2 = n2[0]
				y2 = n2[1]
				tdoa = n1[2] - n2[2]
				ddoa = v * tdoa
				output.append((math.sqrt((x - x1)**2 + (y - y1)**2) - math.sqrt((x - x2)**2 + (y - y2)**2)) - (ddoa - r))

			return tuple(output)

	mean_x = np.mean([row[0] for row in nodes])
	mean_y = np.mean([row[1] for row in nodes])

	inital_guess = (mean_x, mean_y, 0)

	final_guess = least_squares(equations, inital_guess)
	#print(final_guess)

	return [final_guess.x[0], final_guess.x[1]]


#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
# Universal Variables

SPEED_OF_SOUND = 343.0 / 111000.0
NUM_NODES = int(sys.argv[2])
SAMPLE_RATE = 46875
PORT = sys.argv[1]

#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------

# test data
#look in loop beloew to switch between test and uart input
m = [
'C4BAAD0201000000244750474C4C2C333432352E35363832352C4E2C31313935322E33353738322C572C3030313535332E30302C412C412A37300D0A0D',
'0259AC0202000000244750474C4C2C333432352E35383337372C4E2C31313935322E33363132382C572C3030313235392E30302C412C412A37410D0A0D',
'687EC40203000000244750474C4C2C333432352E35363239302C4E2C31313935322E33373433372C572C3030313235382E30302C412C442A37320D0A0D'
]

s = [
'FCFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000100010002000200020002000100000000000000FFFFFEFFFDFFFDFFFDFFFEFFFEFFFFFF000000000100020003000300030002000200010000000000FFFFFEFFFEFFFEFFFEFFFFFF00000000010002000200030003000200020001000000FFFFFEFFFDFFFDFFFDFFFDFFFDFFFEFFFFFF000000000100020003000300030002000200010000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFFFF00000000000000000100010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100010001000000000000000000FFFFFFFFFFFFFEFFFEFFFEFFFFFFFFFF0000000000000100020002000200020002000100010000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF000000000100010002000200020001000100000000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFFFF00000000000001000100020002000200020002000100000000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF000000000000010002000200020001000100000000000000FFFFFFFFFEFFFEFFFEFFFFFF000000000000010001000200020002000100010000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFFFF0000000000000100020002000200020002000100010000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFF0000000000000100010002000200020001000100000000000000FFFFFFFFFEFFFFFFFFFFFFFF000000000000000001000100010001000100000000000000000000000000FFFFFFFF000000000000000000000000000000000100010001000100010001000100000000000000000000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFEFFFFFF00000000000001000200030003000300030003000200010000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000010000000000000000000000000000000000FFFFFFFFFFFF000000000000000000000100010002000200010001000100000000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF0000000000000100010001000100010001000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF00000000000000000100010002000200020001000100000000000000FFFFFEFFFEFFFEFFFEFFFFFFFFFF0000000000000100010001000100010001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010001000100010001000000000000000000FFFFFEFFFEFFFEFFFEFFFEFFFFFF000000000000010001000100020002000100010001000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000000001000100010001000000000000000000000000000000FFFFFFFFFFFFFFFF000000000000000000000000010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFF00000000000000000100010002000200020001000100000000000000FFFFFFFFFFFFFEFFFFFFFFFFFFFF0000000000000000000001000100010001000100000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000001000100020002000200020002000200010000000000FFFFFEFFFDFFFDFFFDFFFDFFFDFFFEFFFFFF000000000100020003000300030002000200010000000000FFFFFEFFFEFFFEFFFEFFFEFFFEFFFFFF0000000001000100020002000200020001000100000000000000FFFFFFFFFEFFFEFFFFFFFFFFFFFF0000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000100010001000200010001000100000000000000FFFFFFFFFFFFFEFFFFFFFFFFFFFF00000000000000000000010001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF0000000000000000000001000100020002000200010001000100000000000000FFFFFEFFFEFFFEFFFEFFFEFFFEFFFFFF0000000000000000010001000200020002000200010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010001000100000000000000000000000000FFFFFFFF0000000000000000000000000000010001000100000000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000001000100010001000100010001000000000000000000FFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000001000100010002000200020001000100000000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFFFF00000000000001000100020002000200020001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000001000100010002000200010001000100000000000000FFFFFFFFFFFFFEFFFEFFFEFFFFFFFFFFFFFF000000000000000000000100010001000100000000000000FFFFFFFFFFFF00000100040007000B000F0013001500150013000F0009000000F8FFEFFFE6FFDFFFDAFFD7FFD7FFD9FFDAFFDBFFD9FFD5FFCEFFC6FFBFFFBBFFBEFFCAFFE3FF070039007600B800F90032015901680158012501D1005D00D4FF3EFFAAFE28FEC5FD8EFD8BFDC1FD2CFEC7FE83FF4E001901CC015802AD02C202940226028401BC00E3FF0DFF4FFEBDFD65FD50FD7FFDF0FD96FE62FF3E001801DA017002CD02E602B9024B02A501D700F4FF0EFF3DFE92FD1CFDE8FCF8FC4DFDDCFD9AFE76FF5A003501F1018002D502E902BC025402BA01FE00310067FFB0FE1BFEB7FD8AFD97FDDCFD4FFEE5FE8EFF3B00DC006301C501FA01FF01D601850114019000050082FF0FFFB7FE81FE6EFE80FEB2FEFDFE5BFFC1FF24007F00C800FC0016011601FE00D200970052000C00CAFF91FF67FF4FFF49FF56FF74FF9EFFD1FF06003A00650084009400930081005F003100FDFFC6FF94FF6BFF50FF47FF51FF6EFF9CFFD7FF18005C009A00CD00EF00FD00F300D3009F005B000D00BCFF6FFF2CFFFAFEDEFED9FEEDFE18FF55FFA1FFF3FF45009100CF00FC0013011201FC00D100970052000800C2FF83FF51FF30FF22FF27FF40FF69FF9EFFDAFF160050008200A700BC00C000B20095006B003700FFFFC6FF93FF68FF4AFF3CFF3EFF51FF73FFA1FFD7FF100049007C00A500C100CC00C500AE00870055001C00E1FFA9FF79FF57FF45FF47FF5AFF7EFFAFFFE7FF1F0054007D009800A10096007A0050001D00E7FFB4FF8BFF71FF68FF72FF8DFFB5FFE7FF19004A007000890092008A0073004F002400F8FFCEFFACFF94FF8AFF8EFF9EFFB7FFD7FFF9FF180033004800530056005100440032001E000700F3FFDFFFCEFFC1FFB7FFB3FFB2FFB7FFC0FFCEFFE1FFF7FF0E00280040005600670071007200690057003C001A00F5FFCFFFACFF8FFF7CFF74FF79FF8BFFA7FFCBFFF4FF1D004300630079008300820075005F0041002000FEFFDEFFC2FFACFF9EFF98FF9AFFA2FFB1FFC4FFDBFFF3FF0A0022003700490056005F0061005C0050003E0026000A00ECFFCFFFB4FFA0FF94FF91FF99FFAAFFC4FFE3FF04002500430059006500680060004E0036001A00FEFFE4FFCDFFBEFFB7FFB7FFBEFFCBFFDBFFEDFFFFFF0E001A00220027002800250021001A0013000B000300FDFFF5FFEFFFE9FFE4FFE2FFE1FFE4FFE9FFF0FFFAFF040010001B0023002700280024001B000F000100F3FFE5FFDAFFD4FFD2FFD7FFE0FFEEFFFEFF0D001C0028002E0030002B00220015000600F7FFE9FFDEFFD6FFD3FFD5FFDAFFE3FFEDFFF8FF02000C0014001A001D001F001F001D001B00170013000E0008000200FBFFF4FFECFFE4FFDEFFDAFFD9FFDBFFE0FFE8FFF2FFFEFF0A001600200027002A002A0025001D0012000600FAFFEFFFE6FFE0FFDEFFDFFFE3FFEAFFF3FFFCFF05000C00130016001800170013000F0009000300FFFFFAFFF6FFF3FFF2FFF2FFF2FFF4FFF7FFFAFFFDFF00000300050008000A000B000B000A000800060003000000FDFFFAFFF8FFF7FFF6FFF7FFF8FFFBFFFEFF0000030005000700080008000700050003000100FFFFFDFFFBFFFAFFF9FFF9FFFAFFFBFFFCFFFDFFFFFF0000010003000400050006000700070007000600040002000000FEFFFCFFFAFFF9FFF8FFF9FFFAFFFBFFFDFF0000010003000400050005000400030002000000FFFFFEFFFEFFFDFFFEFFFEFFFFFF000000000000000000000000000000000000000000000000000001000200020002000200020001000000FFFFFEFFFDFFFDFFFCFFFDFFFDFFFEFFFFFF000000000100020002000200020002000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000010002000300030003000200010000000000FFFFFEFFFDFFFDFFFDFFFDFFFEFFFFFF00000100020002000300030002000200010000000000FFFFFEFFFEFFFDFFFDFFFDFFFEFFFEFFFFFF0000000001000200040005000600060006000500040003000100FFFFFDFFFBFFF9FFF7FFF7FFF7FFF8FFFAFFFDFF0000020004000600070008000700060004000100FFFFFDFFFBFFFAFFF9FFFAFFFBFFFDFF00000100040006000700080008000700050003000100FFFFFDFFFCFFFAFFF9FFF9FFFAFFFAFFFBFFFDFFFFFF000001000200040005000500060005000500040002000000FFFFFDFFFBFFFAFFF9FFF9FFF9FFFAFFFCFFFEFF000002000400060008000900090008000700050002000000FEFFFCFFFAFFF8FFF8FFF8FFF9FFFAFFFCFFFFFF00000200050006000700070007000500040001000000FDFFFBFFF9FFF8FFF8FFF9FFFAFFFCFFFFFF000003000600080009000A0009000700050002000000FDFFFAFFF8FFF6FFF6FFF6FFF8FFFBFFFEFF000003000600080009000A0009000700050002000000FDFFFAFFF8FFF7FFF7FFF8FFF9FFFBFFFEFF00000300060008000900090008000700050002000000FDFFFBFFF9FFF8FFF8FFF9FFFAFFFCFFFEFF000002000400050005000400030002000000FFFFFEFFFDFFFCFFFDFFFEFFFFFF000002000300040005000400030002000000FFFFFEFFFDFFFCFFFCFFFDFFFEFFFFFF000002000300040004000400030002000000FFFFFEFFFCFFFBFFFAFFFAFFFAFFFBFFFCFFFDFFFFFF00000100030004000600070008000800080007000600040002000000FEFFFBFFFAFFF8FFF8FFF8FFF9FFFAFFFCFFFEFF0000020003000400040004000300020001000000FFFFFFFFFEFFFEFFFFFF00000000010001000200020001000100000000000000FFFFFFFF00000000000000000100010001000100010000000000FFFFFEFFFEFFFDFFFEFFFEFFFFFF0000000001000100020001000100000000000000FFFFFEFFFEFFFEFFFFFF0000000001000100020002000200020002000100000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000010001000100010001000100000000000000FEFFFDFFFCFFFBFFFBFFFBFFFCFFFDFFFFFF00000200040006000800080008000700050002000000FEFFFBFFF9FFF8FFF7FFF7FFF8FFFAFFFDFFFFFF010004000600070008000800070006000500030001000000FEFFFCFFFBFFFAFFFAFFFAFFFBFFFCFFFDFFFEFF00000000010002000300030004000300030002000100000000000000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000FFFFFEFFFDFFFCFFFBFFFBFFFCFFFDFFFFFF0100050009000E00130018001B001E001E001C00170010000500FAFFEBFFDBFFCBFFBDFFB1FFA9FFA6FFAAFFB4FFC4FFDAFFF6FF1400350054007100880098009E0099008A0071004F002600FAFFCCFFA1FF7BFF5EFF4DFF48FF50FF65FF85FFADFFDBFF0A00380060007F0093009A0095008300680045001E00F8FFD3FFB5FF9FFF94FF93FF9CFFAFFFC8FFE6FF040022003B004E0058005A00530044002F001700FDFFE4FFCEFFBDFFB3FFB1FFB7FFC3FFD6FFECFF020018002B0039004000400039002C001A000600F2FFE0FFD1FFC8FFC5FFC9FFD3FFE1FFF3FF0400160025002F0035003500300027001B000E000000F5FFECFFE5FFE2FFE1FFE3FFE7FFECFFF1FFF6FFFAFFFEFF00000100020003000300040005000600070009000A000C000D000E000F000F000E000C00090005000000',
'FBFFFFFF000000000100010002000200020002000200020001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFF00000000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001000100010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFF00000000000000000100010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000100020002000300030003000200020001000000FFFFFEFFFDFFFDFFFDFFFDFFFDFFFEFFFFFF0000000001000200020003000200020002000100000000000000FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000010001000100010000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF0000000000000000000001000100020002000200020002000100000000000000FFFFFFFFFEFFFEFFFEFFFFFF0000000000000000010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000001000200020003000300020002000100000000000000FFFFFEFFFEFFFEFFFEFFFEFFFEFFFFFFFFFF0000000000000000010001000100010001000100010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010001000000000000000000FFFFFFFFFFFFFFFF00000000000000000000000001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010002000200020002000100000000000000FFFFFEFFFDFFFDFFFDFFFDFFFEFFFFFF0000000001000200030003000300030002000100010000000000FFFFFEFFFEFFFDFFFDFFFEFFFEFFFFFFFFFF0000000001000100020002000200020002000100000000000000FFFFFFFFFEFFFEFFFEFFFFFFFFFF000000000000010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFEFFFEFFFFFFFFFF00000000000000000100010002000200020001000100000000000000FFFFFFFFFEFFFEFFFFFFFFFF000000000000010002000200020002000200010000000000FFFFFEFFFEFFFDFFFDFFFEFFFEFFFFFF000000000100020003000300030003000200010000000000FFFFFEFFFDFFFDFFFDFFFEFFFEFFFFFF00000000010002000200020002000200010000000000FFFFFFFFFEFFFEFFFEFFFFFFFFFF00000000000001000100010002000200010001000000000000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFFFFFF000000000000010001000200020002000200020002000100000000000000FFFFFEFFFEFFFEFFFEFFFEFFFFFFFFFF000000000100010002000200020001000100000000000000FFFFFFFFFEFFFEFFFFFFFFFFFFFF000000000000000001000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000200020003000300030002000100010000000000FFFFFEFFFDFFFDFFFDFFFDFFFEFFFFFF0000000000000100020002000200010001000100000000000000000000000000000000000000000000000000000000000000000000000000010001000200020002000200010000000000FFFFFEFFFDFFFCFFFCFFFCFFFDFFFEFFFFFF000001000200030004000400040004000300010000000000FEFFFDFFFDFFFDFFFDFFFDFFFEFFFFFF0000000001000200020002000300020002000100000000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF0000000000000100571C77060200010001000000000000000000FFFFFFFFFFFFFFFF00000000000000000100010001000100000000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFFFF0000000001000200030003000300030003000200010000000000FFFFFEFFFEFFFDFFFDFFFEFFFEFFFFFFFFFF00000000000001000100010002000100010001000100000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000010001000100010000000000000000000000000000000000000000000000000000000000010001000100010000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000000000100000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000010001000200020002000200020001000100000000000000FFFFFEFFFEFFFEFFFEFFFEFFFEFFFFFFFFFF000000000000010001000100010001000100010001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000100010001000100010001000000000000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF0000000001000100020002000300020002000100010000000000FFFFFEFFFDFFFDFFFDFFFEFFFEFFFFFF0000000001000100020002000200020002000100010000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF000000000000010001000200030004000400040005000400040004000300030002000200010000000000FFFFFDFFF9FFF3FFEAFFDFFFD0FFBFFFACFF9BFF8EFF89FF8EFFA0FFC3FFF6FF3A008B00E4003C018801C001DB01D0019C013D01B5000E0054FF95FEE2FD4EFDE8FCBDFCD2FC29FDBCFD7EFE5EFF47002501E5017602CC02E402BF026502E3014C01B0002100AEFF5FFF37FF36FF53FF85FFBEFFF3FF160021001000E4FFA1FF51FFFFFEB7FE85FE6FFE7CFEACFEFCFE66FFDFFF5C00D3003A018801B901C901BB0190014F01FC00A0004000E3FF8CFF40FF02FFD5FEB8FEAFFEB7FED3FEFFFE3BFF84FFD5FF28007800C000F9001F012F0126010501CF008A003D00F1FFABFF71FF48FF32FF31FF43FF63FF8EFFBEFFEDFF150037004D0059005B0055004B003D002F00230017000C000200F7FFEBFFDEFFD0FFC3FFB8FFB0FFAFFFB4FFC2FFD8FFF4FF130034005100690078007C0074006100460024000000DEFFC1FFABFF9EFF9AFFA0FFADFFC0FFD6FFECFF000010001C0023002600260023001F001C00190017001500140012000F000A000500FEFFF6FFEDFFE6FFE0FFDCFFDCFFDFFFE4FFECFFF5FFFEFF05000D001200150016001600140012000F000D000B000900070005000200FFFFFBFFF6FFF0FFECFFE8FFE7FFE8FFEBFFF1FFF9FF01000900110018001B001B00180013000B000300FCFFF5FFF0FFEEFFEEFFF1FFF5FFFAFFFFFF01000400040002000000FDFFFAFFF8FFF8FFFAFFFFFF04000C00130019001D001E001B0014000A000000F3FFE8FFDEFFD9FFD7FFDAFFE1FFEBFFF7FF03000E0017001D001F001D001800110009000100FBFFF7FFF5FFF5FFF8FFFCFF0000030006000700060003000000FCFFF8FFF4FFF3FFF3FFF5FFF8FFFDFF010006000A000C000C000B00080004000000FDFFF9FFF7FFF7FFF8FFFAFFFEFF0000040007000A000B000A00080005000200FFFFFCFFF9FFF7FFF6FFF6FFF7FFF9FFFCFFFFFF0100040006000700080008000600050003000000FFFFFCFFFBFFFAFFF9FFF9FFFAFFFCFFFEFF000002000400060007000700070007000600040002000000FFFFFDFFFBFFFAFFF9FFF8FFF9FFF9FFFAFFFCFFFEFF0000010003000500060007000700070006000500030001000000FEFFFDFFFBFFFBFFFBFFFCFFFDFFFFFF000001000200030003000200010000000000FEFFFDFFFDFFFCFFFCFFFDFFFEFFFFFF000000000100020003000400040005000500040004000300020001000000FEFFFCFFFBFFF9FFF9FFF9FFFAFFFBFFFEFF0000020004000600070007000600050002000000FEFFFCFFFAFFF9FFFAFFFBFFFDFF000002000400060007000700060003000100FFFFFCFFF9FFF7FFF7FFF7FFF9FFFBFFFEFF01000400070009000A000A000A000800060003000100FFFFFDFFFBFFFAFFFAFFFAFFFBFFFCFFFCFFFDFFFEFFFEFFFFFFFFFFFFFFFFFFFFFF000000000000010002000300040004000500050005000400030002000100000000000000FFFFFEFFFEFFFEFFFDFFFDFFFDFFFDFFFDFFFCFFFDFFFDFFFDFFFEFFFFFF00000000020003000400050006000600060005000400030001000000FFFFFDFFFCFFFBFFFBFFFBFFFCFFFDFFFEFFFFFF000000000100020002000200020002000100000000000000FFFFFFFFFFFFFFFFFFFF0000000001000200030003000400040004000300020000000000FEFFFDFFFBFFFAFFFAFFFAFFFBFFFCFFFDFFFFFF00000200040006000600060006000500030002000000FFFFFDFFFCFFFCFFFCFFFCFFFDFFFEFFFFFF00000000010001000100000000000000FFFFFFFFFFFFFFFFFFFF000000000100020003000400040004000300020001000000FFFFFEFFFDFFFCFFFCFFFCFFFCFFFCFFFDFFFEFFFFFF0000000001000300040005000500050005000500030002000000FFFFFDFFFCFFFAFFFAFFF9FFFAFFFBFFFCFFFEFF000002000400050006000600060005000400020001000000FEFFFDFFFCFFFBFFFBFFFBFFFCFFFDFFFEFFFFFF000001000200030004000400040003000300020001000000FFFFFEFFFDFFFCFFFCFFFCFFFCFFFDFFFEFF000000000200030004000500050005000400030001000000FEFFFDFFFCFFFBFFFBFFFBFFFCFFFDFFFFFF000001000200030004000400040003000200010000000000FFFFFEFFFEFFFDFFFDFFFEFFFFFFFFFF0000000001000200030003000400040004000300020000000000FEFFFCFFF9FFF8FFF6FFF6FFF6FFF7FFF9FFFDFF0000040008000D00100012001300120010000C0006000000FBFFF5FFEFFFEBFFE9FFE9FFEAFFEEFFF2FFF8FFFFFF04000A000F00120015001500140011000E00090004000000FBFFF6FFF3FFF0FFEFFFEFFFF1FFF3FFF7FFFBFFFFFF030007000A000C000D000C000B00080005000200FFFFFDFFFBFFFAFFFAFFFBFFFDFFFFFF00000200030004000300020001000000FDFFFCFFFAFFF9FFF9FFFAFFFCFFFEFF0000020004000600070008000900080007000500040001000000FEFFFCFFFAFFF8FFF7FFF7FFF7FFF8FFFAFFFCFFFFFF010004000600080009000A0009000800060003000000FFFFFCFFFAFFF9FFF9FFF9FFFAFFFCFFFDFFFFFF0000000001000100010001000000000000000000000001000200030004000500050005000400030001000000FDFFFBFFF9FFF8FFF8FFF8FFF9FFFAFFFCFFFEFF000002000400060007000700070006000500030001000000FFFFFEFFFDFFFCFFFCFFFCFFFDFFFDFFFEFFFFFF0000000001000200020002000200010000000000FFFFFEFFFDFFFCFFFCFFFCFFFDFFFFFF000002000400060007000800080007000600040001000000FDFFFAFFF8FFF7FFF6FFF7FFF8FFFAFFFCFFFFFF000002000400060006000700060005000400030001000000FFFFFEFFFEFFFDFFFDFFFDFFFDFFFEFFFFFFFFFF000000000000010001000200020001000100010000000000000000000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001000100010000000000000000000000FFFFFFFFFEFFFEFFFFFFFFFFFFFF00000000000001000100010001000100010001000000000000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFFFFFF0000000001000200020003000300030003000200010000000000FEFFFEFFFDFFFDFFFDFFFEFFFFFF00000000010002000300040004000300020001000000FEFFFBFFF9FFF7FFF5FFF4FFF3FFF3FFF3FFF4FFF7FFFAFFFEFF020008000F0015001C00230028002C002E002E002B0024001B000F000100F2FFE1FFD0FFC0FFB2FFA7FFA0FF9FFFA3FFACFFBBFFCFFFE7FF01001D003800510067007700800082007C006E005A00400022000300E5FFC9FFB1FFA0FF96FF93FF98FFA4FFB6FFCBFFE2FFF8FF0C001C0028002E002E002A00220017000C000100FAFFF5FFF4FFF6FFFCFF04000E00180021002600280025001E0013000500F6FFE6FFD7FFCBFFC4FFC2FFC6FFCEFFDCFFEDFFFFFF11002200300039003C003A003300270018000800F9FFEAFFDEFFD6FFD3FFD5FFDAFFE3FFEEFFFAFF04000E0016001A001B001A0015000F0009000100FCFFF7FFF3FFF1FFF1FFF2FFF5FFF8FF',
'FDFF00000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFF00000000000000000000000000000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100010001000100000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000100010001000100010001000000000000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFF0000000000000000000000000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000000000000100010001000100000000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000000000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFF000000000000000000000000000001000100010001000000000000000000000000000000FFFFFFFFFFFFFFFF00000000000000000000000001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000100010001000100010000000000000000000000000000000000FFFF00000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000001000100010002000200010001000100000000000000FFFFFFFFFEFFFEFFFEFFFFFFFFFF00000000000000000100010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000100010002000200010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000100010001000100010001000100000000000000FFFFFFFFFFFFFEFFFEFFFFFFFFFF00000000000001000100020002000200020001000100000000000000FFFFFFFFFEFFFEFFFEFFFFFFFFFF00000000000001000100010002000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000010001000100000000000000000000000000000000000000FFFFFFFF000000000000000000000000000000000100010001000100000000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000001000100010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000010001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000000000000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000000000000000100010001000100000000000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000000000000000010001000000000000000000000000000000000000000000000000000000000000000000000000000100010001000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000000001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFF0000000000000000000001000100010001000100010000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000000010001000100010000000000000000000000000000000000FFFFFFFF0000000000000000000000000000010001000100010001000100010001000100010001000100010001000100010001000100010000000000FEFFFCFFF8FFF4FFEEFFE8FFE3FFDDFFD9FFD7FFD8FFDDFFE5FFF2FF020016002C00430059006C007A00820081007700640048002500FEFFD3FFA9FF83FF64FF4DFF42FF42FF4FFF66FF87FFB0FFDCFF08003200580076008C00970098009000800069004E0032001500FDFFE7FFD7FFCCFFC8FFC9FFCFFFD7FFE2FFECFFF5FFFBFFFEFFFDFFF9FFF2FFEAFFE1FFDAFFD6FFD6FFDBFFE4FFF2FF030016002800390045004B004B004400370024000E00F8FFE1FFCEFFC0FFB8FFB6FFBBFFC5FFD4FFE5FFF8FF0800180025002D003200320030002A0023001B00120008000000F8FFF0FFE9FFE3FFDFFFDDFFDDFFDFFFE3FFEAFFF2FFFCFF0600100018001F002300230021001B0013000A000100F9FFF1FFEBFFE8FFE7FFE9FFECFFF1FFF5FFFAFFFEFF010003000500060007000700080009000A000B000B000B000A00080005000100FEFFFAFFF6FFF3FFF2FFF1FFF2FFF5FFF8FFFCFF000003000600080009000900080006000400020000000000FFFFFEFFFEFFFEFFFEFFFDFFFDFFFCFFFCFFFCFFFCFFFDFFFEFF000001000400060008000A000A000900080005000200FFFFFCFFF9FFF7FFF5FFF5FFF5FFF7FFF9FFFBFFFEFF0000020004000500060007000700070006000600050004000300010000000000FEFFFDFFFCFFFBFFFBFFFBFFFCFFFDFFFEFF0000000001000100010000000000FFFFFFFFFEFFFEFFFEFFFAFF00000100030005000600070007000700050003000100FFFFFDFFFBFFF9FFF8FFF8FFF9FFFAFFFCFFFEFF000000000200030003000400040003000300020001000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF00000000010002000300040004000400030002000000FFFFFEFFFCFFFAFFF9FFF9FFF9FFFAFFFCFFFEFF000001000300050006000600060005000400020001000000FFFFFEFFFEFFFEFFFEFFFFFF0000000000000100010001000100010000000000FFFFFFFFFEFFFEFFFDFFFDFFFEFFFEFFFFFFFFFF00000000010002000200030003000300030002000200010000000000FFFFFFFFFEFFFEFFFEFFFEFFFFFF0000000000000000010001000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000100010002000200010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000100010002000200020002000100010000000000FFFFFFFFFEFFFEFFFEFFFEFFFEFFFFFFFFFF000000000000010001000100010001000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100010002000200010001000100000000000000FFFFFFFFFEFFFEFFFEFFFFFFFFFF000000000000010001000100010001000000000000000000FFFFFFFFFFFFFFFFFFFF0000000000000000010001000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001000100000000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000100010001000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000010001000100000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000001000100010002000200010001000100000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000010001000100010001000000000000000000000000000000000000000000000000000000000000000000010001000100000000000000000000000000000000000000FFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFF000000000000000000000000010001000100010001000100000000000000000000000000FFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFEFFFEFFFDFFFCFFFCFFFBFFFBFFFBFFFCFFFDFFFEFF00000200040007000A000C000E0010001100110010000E000A0007000200FEFFF8FFF3FFEEFFEAFFE7FFE5FFE5FFE6FFE9FFEDFFF2FFF8FFFEFF04000A000F0014001700190019001800150012000E00090005000000FEFFFBFFF8FFF7FFF6FFF6FFF6FFF7FFF8FFF8FFF9FFFAFFFAFFFBFFFCFFFCFFFDFFFFFF0000010003000500070008000900090009000800060004000100FFFFFDFFFAFFF7FFF6FFF5FFF5FFF6FFF7FFFAFFFDFF00000300060009000B000D000D000C000A00080005000100FFFFFCFFF9FFF7FFF6FFF5FFF6FFF7FFF9FFFCFFFEFF000002000400050006000600050004000300020000000000FFFFFEFFFEFFFEFFFEFFFFFF0000000001000100020002000200010000000000FFFFFEFFFDFFFDFFFDFF'
]

#formatting is [output_name, output_time, output_gps, output_sound]
node_list = []

for i in range(NUM_NODES):
	
	# uart input
    #meta, sound = get_uart(port=PORT, baud=115200, timeout_val=0)
    
    # test input
    meta = m[i].lower()
    sound = s[i].lower()
    

    node_list.append(parse_uart(meta, sound))

node_list[0].append(0)

#adjust for fact that longitude is terrible
long_multiplier = 180 / (180 - node_list[0][2][1])

node_locs = []
for node in node_list:

    x = node[2][0]
    y = node[2][1]

    x_mod = x*long_multiplier
    y_mod = y
    node_locs.append([x_mod, y_mod])


node_times = [0]

for node in node_list[1:]:
    tdoa = cross_correlation(node_list[0][1], node_list[0][3], node[1], node[3], SAMPLE_RATE)
    node_times.append(tdoa)

#print(node_locs)
#print(node_times)

pred_x, pred_y = LST(node_locs, node_times, SPEED_OF_SOUND)

pred_x = pred_x / long_multiplier

#frac_x, whole_x = math.modf(pred_x)
#pred_x_decimal = whole_x + (frac_x * 100) / 60

#frac_y, whole_y = math.modf(pred_y)
#pred_y_decimal = whole_y + (frac_y * 100) / 60


print('predicited latititude: ', pred_y)
print('predicited longitude: ', pred_x)

#x, y
true_sound = [0, 0]

BBox = (-119.87359, -119.87242, 34.42555, 34.42649)
girsh_park_map = plt.imread('girsh_baseball_map.png')

#print(node_locs)
for i, n in enumerate(node_locs):
	node_locs[i][0] = n[0] / long_multiplier

	#frac_x, whole_x = math.modf(n[0])
	#node_locs[i][0] = whole_x + (frac_x * 100) / 60
	
	#frac_y, whole_y = math.modf(n[1])
	#node_locs[i][1] = whole_y + (frac_y * 100) / 60

#print(node_locs)

plt.scatter(node_locs[0][0], node_locs[0][1], color = 'black', marker='$A$')
plt.scatter(node_locs[1][0], node_locs[1][1], color = 'black', marker='$B$')
plt.scatter(node_locs[2][0], node_locs[2][1], color = 'black', marker='$C$')

plt.scatter(true_sound[0], true_sound[1], color = 'red', marker='o')
plt.scatter(pred_x, pred_y, color = 'blue', marker='x')
plt.imshow(girsh_park_map, zorder=0, extent = BBox, aspect= 'equal')
plt.show()